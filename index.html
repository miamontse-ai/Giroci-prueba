<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GirOci</title>
    <link rel="manifest" href="manifest.json?v=100">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: linear-gradient(180deg, #38b6ff 0%, #43e97b 100%); min-height: 100vh; font-family: sans-serif; margin: 0; overflow-x: hidden; }
        #splash-screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: space-around; z-index: 9999; background: linear-gradient(180deg, #38b6ff 0%, #43e97b 100%); transition: opacity 0.5s ease; }
        .logo-splash { width: 85%; max-width: 450px; }
        .btn-entrar { background: white; color: #1e5d8a; padding: 20px 70px; border-radius: 50px; font-weight: 900; font-size: 1.5rem; border: none; cursor: pointer; }
        #main-content { display: none; padding: 10px 15px; max-width: 500px; margin: 0 auto; }
        .custom-select { position: relative; }
        .select-trigger { background: #1e5d8a; border-radius: 20px; padding: 12px 15px; color: white; display: flex; align-items: center; justify-content: space-between; font-weight: 800; cursor: pointer; }
        .options-menu { position: absolute; top: 110%; left: 0; right: 0; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: none; z-index: 2000; overflow-y: auto; max-height: 300px; padding: 10px; }
        .options-menu.show { display: block; }
        .option-item { padding: 12px; display: flex; align-items: center; gap: 10px; color: #333; font-weight: 700; cursor: pointer; border-radius: 10px; }
        .flag-icon { width: 20px; height: 14px; object-fit: cover; }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="logo.png" class="logo-splash">
        <button class="btn-entrar" onclick="entrarApp()">ENTRAR</button>
    </div>

    <div id="main-content">
        <div class="flex justify-end mb-4">
            <div class="custom-select w-[110px]">
                <div class="select-trigger !bg-white/20" onclick="toggleMenu('langMenu')">
                    <span id="sel-lang" class="flex items-center gap-2 text-xs"><img src="bandera_ca.png" class="flag-icon"> CAT</span>
                </div>
                <div id="langMenu" class="options-menu">
                    <div class="option-item" onclick="changeLang('ca', 'bandera_ca.png', 'CAT')"><img src="bandera_ca.png" class="flag-icon"> CAT</div>
                    <div class="option-item" onclick="changeLang('es', 'bandera_es.png', 'ESP')"><img src="bandera_es.png" class="flag-icon"> ESP</div>
                    <div class="option-item" onclick="changeLang('en', 'bandera_en.png', 'ENG')"><img src="bandera_en.png" class="flag-icon"> ENG</div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-center gap-2 mb-8">
            <img src="logo.png" class="w-20 h-20 object-contain">
            <h1 class="text-5xl text-white font-black">GirOci</h1>
        </div>

        <div class="flex gap-2 mb-8">
            <div class="custom-select flex-1">
                <div class="select-trigger" onclick="toggleMenu('typeMenu')"><span id="txt-type">Tipus d'Oci</span></div>
                <div id="typeMenu" class="options-menu"></div>
            </div>
            <div class="custom-select flex-1">
                <div class="select-trigger" onclick="toggleMenu('comarcaMenu')"><span id="txt-comarca">Comarca</span></div>
                <div id="comarcaMenu" class="options-menu"></div>
            </div>
        </div>

        <h2 id="txt-title" class="text-white text-xl font-bold mb-4">Esdeveniments</h2>
        <div id="events-grid" class="grid grid-cols-2 gap-4"></div>
    </div>

    <div id="pantalla-detalle" class="fixed inset-0 bg-[#1e293b] z-[5000] hidden overflow-y-auto">
        <div class="relative h-[35vh] bg-black">
            <img id="img-det" src="" class="w-full h-full object-contain">
            <button onclick="cerrarDetalle()" class="absolute top-5 left-5 bg-black/50 w-10 h-10 rounded-full text-white"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="p-6">
            <h2 id="tit-det" class="text-white text-2xl font-bold mb-4"></h2>
            <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                <div class="bg-slate-800 p-3 rounded-lg"><p class="text-gray-400">Lloc</p><p id="loc-det" class="text-cyan-400 font-bold"></p></div>
                <div class="bg-slate-800 p-3 rounded-lg"><p class="text-gray-400">Data</p><p id="dat-det" class="text-purple-400 font-bold"></p></div>
                <div class="bg-slate-800 p-3 rounded-lg"><p class="text-gray-400">Hora</p><p id="hor-det" class="text-emerald-400 font-bold"></p></div>
                <div class="bg-slate-800 p-3 rounded-lg"><p class="text-gray-400">Preu</p><p id="pre-det" class="text-orange-400 font-bold"></p></div>
            </div>
            <p id="des-det" class="text-gray-300 text-sm mb-6"></p>
            <div class="flex gap-2">
                <button onclick="abrirMapa()" class="flex-1 bg-slate-700 text-white p-4 rounded-xl font-bold"><i class="fas fa-map-marker-alt mr-2"></i>Mapa</button>
                <button id="btn-res" onclick="irAReserva()" class="flex-1 bg-cyan-500 text-white p-4 rounded-xl font-bold hidden text-center">Reservar</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwxJoxAGAkRVvGlTQ5OQBrWc_aq15uCXjH14y5G0CmtIx_NJgCAJlUM9eeiGwFOgXBx/exec";
        let eventData = [], currentLang = 'ca', currentCat = 'all', currentCom = 'all', currentLink = "", currentDir = "";

        const translations = {
            ca: { type: "Tipus d'Oci", comarca: "Comarca", title: "Esdeveniments Propers", all: "Tots" },
            es: { type: "Tipo de Ocio", comarca: "Comarca", title: "Próximos Eventos", all: "Todos" },
            en: { type: "Leisure Type", comarca: "County", title: "Upcoming Events", all: "All" }
        };

        const cats = {
            conciertos: { ca: "Concerts", es: "Conciertos", en: "Concerts", icon: "fa-music" },
            actividades: { ca: "Activitats", es: "Actividades", en: "Activities", icon: "fa-palette" }
        };

        const comarcas = ["Alt Empordà", "Baix Empordà", "Cerdanya", "Garrotxa", "Gironès", "Pla de l'Estany", "Ripollès", "Selva"];

        async function loadData() {
            try {
                const res = await fetch(SCRIPT_URL);
                eventData = await res.json();
                renderAll();
            } catch (e) { console.error("Error cargando datos"); }
        }

        function renderAll() {
            renderEvents();
            renderMenu('typeMenu', Object.keys(cats), 'cat');
            renderMenu('comarcaMenu', comarcas, 'comarca');
        }

        function renderMenu(id, list, type) {
            const m = document.getElementById(id);
            let html = `<div class="option-item" onclick="filter('${type}', 'all')">Tots</div>`;
            list.forEach(item => {
                const label = type === 'cat' ? cats[item][currentLang] : item;
                html += `<div class="option-item" onclick="filter('${type}', '${item}')">${label}</div>`;
            });
            m.innerHTML = html;
        }

        function filter(type, val) {
            if(type === 'cat') currentCat = val;
            else currentCom = val;
            document.querySelectorAll('.options-menu').forEach(m => m.classList.remove('show'));
            renderEvents();
        }

        function renderEvents() {
            const grid = document.getElementById('events-grid');
            const filtered = eventData.filter(ev => {
                const mCat = currentCat === 'all' || ev.Categoria.toLowerCase() === currentCat.toLowerCase();
                const mCom = currentCom === 'all' || ev.Comarca === currentCom;
                return mCat && mCom;
            });

            grid.innerHTML = filtered.map((ev, index) => `
                <div onclick="abrirDetalle(${index}, '${ev.ID}')" class="bg-white rounded-2xl overflow-hidden shadow-lg cursor-pointer">
                    <img src="${ev.Imagen_URL}" class="h-32 w-full object-cover">
                    <div class="p-3">
                        <h3 class="font-bold text-xs h-8 overflow-hidden">${ev['Titulo_' + currentLang.toUpperCase()] || ev.Titulo_CA}</h3>
                        <p class="text-[10px] text-gray-500 uppercase font-bold mt-1">${ev.Municipio}</p>
                    </div>
                </div>`).join('');
        }

        function abrirDetalle(index, id) {
            // Buscamos por index o por ID de forma segura
            const ev = eventData.find(e => String(e.ID) === String(id)) || eventData[index];
            if(!ev) return;

            const lang = currentLang.toUpperCase();
            document.getElementById('tit-det').innerText = ev['Titulo_' + lang] || ev.Titulo_CA;
            document.getElementById('loc-det').innerText = ev.Municipio;
            document.getElementById('dat-det').innerText = ev.Fecha ? ev.Fecha.split('T')[0] : "";
            document.getElementById('hor-det').innerText = ev.Hora ? ev.Hora.split('T')[1].substring(0, 5) : "--:--";
            document.getElementById('pre-det').innerText = ev.Precio + "€";
            document.getElementById('des-det').innerText = ev['Desc_' + lang] || ev.Desc_CA;
            document.getElementById('img-det').src = ev.Imagen_URL;
            
            currentLink = ev.Link_Entradas;
            currentDir = (ev.Direccion || "") + " " + ev.Municipio;
            
            document.getElementById('btn-res').style.display = (currentLink && currentLink.length > 5) ? "block" : "none";
            document.getElementById('pantalla-detalle').classList.remove('hidden');
        }

        function changeLang(l, f, lbl) {
            currentLang = l;
            document.getElementById('sel-lang').innerHTML = `<img src="${f}" class="flag-icon"> ${lbl}`;
            document.getElementById('txt-type').innerText = translations[l].type;
            document.getElementById('txt-comarca').innerText = translations[l].comarca;
            document.getElementById('txt-title').innerText = translations[l].title;
            renderAll();
        }

        function toggleMenu(id) { 
            const m = document.getElementById(id);
            const open = m.classList.contains('show');
            document.querySelectorAll('.options-menu').forEach(x => x.classList.remove('show'));
            if(!open) m.classList.add('show');
        }

        function entrarApp() {
            document.getElementById('splash-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                loadData();
            }, 500);
        }

        function cerrarDetalle() { document.getElementById('pantalla-detalle').classList.add('hidden'); }
        function irAReserva() { if(currentLink) window.open(currentLink, '_blank'); }
        function abrirMapa() { window.open('https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(currentDir), '_blank'); }
    </script>
</body>
</html>
